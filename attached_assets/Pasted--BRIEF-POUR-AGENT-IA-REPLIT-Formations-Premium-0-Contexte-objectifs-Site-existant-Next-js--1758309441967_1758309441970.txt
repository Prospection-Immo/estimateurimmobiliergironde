âœ… BRIEF POUR AGENT IA REPLIT â€” â€œFormations Premiumâ€
0) Contexte & objectifs

Site existant: Next.js 14 (app router) + TypeScript + Tailwind + shadcn/ui, Supabase (DB + auth), Nginx/PM2 sur VPS.

Objectif: ajouter un module Formations avec:

Catalogue /formations (coming soon possible),

Pages de vente (5 slugs),

Paiement Stripe Checkout /paiement?sku=...,

Webhook Stripe â†’ crÃ©ation commande + accÃ¨s,

Page de remerciement /merci (+ upsell),

Espace client /espace-client (voir ses formations),

Admin lÃ©ger /admin/formations (suivi ventes),

Tracking visionnage (25/50/100%),

Emails post-achat (Resend ou SMTP).

Livrable = code complet, testÃ© en local avec Stripe CLI, prÃªt Ã  dÃ©ployer (variables dâ€™env prod + Nginx).

1) ENV & variables (ajouter Ã  .env / secrets Replit)
# Stripe
STRIPE_SECRET_KEY=sk_live_or_test_********
STRIPE_WEBHOOK_SECRET=whsec_********
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_or_test_********

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ey********
SUPABASE_SERVICE_ROLE_KEY=ey********  # (server only)

# Email (choisir lâ€™un)
RESEND_API_KEY=re_********
# OU SMTP
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=no-reply@example.com
SMTP_PASS=********

2) Stripe â€” produits & â€œlookup_keysâ€

CrÃ©er 5 prices dans Stripe (Dashboard ou script) avec lookup_key pour chaque SKU:

ESTIMER97 â†’ 97â‚¬ TTC (one-time)

FACE147 â†’ 147â‚¬ TTC (one-time)

QUALI97 â†’ 97â‚¬ TTC (one-time)

PO147 â†’ 147â‚¬ TTC (one-time)

PACK397 â†’ 397â‚¬ TTC (one-time)

(optionnel upsell immÃ©diat) UPSELLPACK300 â†’ 300â‚¬ TTC (one-time)

Notes:

Activer Tax comportement inclus si TVA incluse.

Renseigner â€œProduct nameâ€ = titre public (ex: â€œEstimer son bien comme un proâ€).

Garder lâ€™ID Price mais utiliser lookup_key cÃ´tÃ© backend (plus robuste).

3) Supabase â€” schÃ©ma SQL (crÃ©er migration)
-- users: dÃ©jÃ  gÃ©rÃ© par Supabase Auth (sinon crÃ©er table miroir)
create table if not exists courses (
  sku text primary key,
  title text not null,
  slug text not null unique,
  price_cents int not null,
  description text,
  created_at timestamptz default now()
);

create table if not exists orders (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null,
  stripe_session_id text not null unique,
  total_cents int not null,
  currency text not null default 'eur',
  status text not null default 'paid', -- 'paid','refunded'
  utm_source text,
  utm_medium text,
  utm_campaign text,
  created_at timestamptz default now()
);

create table if not exists order_items (
  id uuid primary key default gen_random_uuid(),
  order_id uuid references orders(id) on delete cascade,
  sku text references courses(sku),
  unit_price_cents int not null,
  qty int not null default 1
);

create table if not exists enrollments (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null,
  sku text references courses(sku),
  access_expires_at timestamptz,
  created_at timestamptz default now(),
  unique (user_id, sku)
);

create table if not exists events (
  id uuid primary key default gen_random_uuid(),
  user_id uuid,
  sku text,
  type text, -- 'video_start','video_25','video_50','video_100','download_model'
  meta jsonb,
  created_at timestamptz default now()
);

-- Seed cours
insert into courses (sku, title, slug, price_cents, description) values
('ESTIMER97','Estimer son bien comme un pro','estimer-bien',9700,'MÃ©thode simple, fiable, reproductible.'),
('FACE147','Promouvoir son bien avec Facebook','facebook-immobilier',14700,'Publier, booster, capter des contacts qualifiÃ©s.'),
('QUALI97','Qualifier ses acheteurs','qualifier-acheteurs',9700,'Scripts et signaux pour filtrer efficacement.'),
('PO147','Porte ouverte unique & optimisÃ©e','porte-ouverte-optimisee',14700,'Organisation, calendrier, mise en scÃ¨ne, effet dâ€™urgence.'),
('PACK397','Pack complet â€œDevenir son propre agentâ€','pack-complet',39700,'Les 4 formations + modÃ¨les prÃªts Ã  lâ€™emploi.')
on conflict do nothing;

4) Arborescence & routes (app router)

CrÃ©er/complÃ©ter:

/app
  /formations/page.tsx               # Catalogue
  /formations/[slug]/page.tsx        # Vente dynamique
  /paiement/page.tsx                 # CrÃ©ation checkout session
  /merci/page.tsx                    # Merci + upsell
  /espace-client/page.tsx            # Mes formations
  /admin/formations/page.tsx         # Admin lÃ©ger

/api
  /checkout/route.ts                 # POST -> Stripe Checkout
  /stripe/webhook/route.ts           # POST -> Webhook
  /events/video/route.ts             # POST -> log vidÃ©o progress
  /email/receipt/route.ts            # POST -> envoyer facture / accÃ¨s (optionnel)

5) Contenu (JSON/TS centralisÃ©)

CrÃ©er /content/courses.ts pour le copywriting (titres, bullets, FAQ, bonus, CTA). Remplir dâ€™aprÃ¨s le texte fourni prÃ©cÃ©demment.

Exemple structure:

export type Course = {
  sku: string;
  slug: string;
  title: string;
  price: number; // euros
  hero: { h1: string; hook: string; proof?: string };
  learn: string[];
  deliverables: string[];
  guarantee: string;
  ctaLabel: string; // "Obtenir la formation â€“ 97â‚¬"
};

export const courses: Record<string, Course> = {
  ESTIMER97: { /* ... contenu ... */ },
  FACE147: { /* ... */ },
  QUALI97: { /* ... */ },
  PO147: { /* ... */ },
  PACK397: { /* ... */ }
};

6) Catalogue /formations

Grille de cards depuis courses.ts.

Bandeau â€œArrive trÃ¨s bientÃ´t / PrÃ©-lancementâ€ (feature flag COMING_SOON=true via env; si true, les boutons â€œacheterâ€ -> dÃ©sactivÃ©s + modal email).

CTA â€œÃŠtre prÃ©venuâ€ â†’ modal -> POST vers MailerLite/Sendy/Resend list (stub pour lâ€™instant).

7) Pages de vente /formations/[slug]

Lire slug â†’ trouver sku â†’ piocher texte dans courses.ts.

Sections: H1/Hook, â€œCe que vous allez apprendreâ€, â€œCe que vous recevezâ€, â€œGarantieâ€, FAQ courte, CTA principal â€œObtenir la formation â€“ {prix}â€.

Bouton â†’ /paiement?sku=${sku} (si COMING_SOON actif: griser + modal).

8) Paiement /paiement

Lire sku en query; si absent â†’ redirect /formations.

Bouton â€œPayer et accÃ©der aux vidÃ©osâ€ appelle POST /api/checkout avec:

sku

success_url = ${origin}/merci?session_id={CHECKOUT_SESSION_ID}

cancel_url = ${origin}/formations/${slug}

client_reference_id = userId (si connectÃ© Supabase)

metadata = { sku, utm_* }

Serverâ€side, mapper sku â†’ lookup_key, crÃ©er Checkout Session (mode=payment, allow_promotion_codes=true).

Rediriger vers session.url.

9) Webhook Stripe /api/stripe/webhook

VÃ©rifier signature STRIPE_WEBHOOK_SECRET.

Sur checkout.session.completed:

RÃ©cupÃ©rer session (email, amount_total, currency, client_reference_id, metadata.sku).

Associer/crÃ©er user (via Supabase Admin) si besoin.

InsÃ©rer orders + order_items.

CrÃ©er enrollments (user_id, sku).

Envoyer email dâ€™accÃ¨s (Resend/SMTP).

Option: si sku != PACK397 proposer upsell sur /merci (query upsell=1).

10) Page Merci /merci

â€œMerci, accÃ¨s prÃªtâ€ + bouton â€œAccÃ©der Ã  ma formationâ€ â†’ /espace-client.

Bloc Upsell immÃ©diat (si user nâ€™a pas PACK397): offre UPSELLPACK300 avec timer 20 min (state local). Boutons:

â€œOui, je veux le pack Ã  300â‚¬â€ â†’ /paiement?sku=UPSELLPACK300

â€œNon merci, accÃ©der Ã  ma formationâ€

11) Espace client /espace-client

Guard auth Supabase.

Lister enrollments â†’ cards par sku.

Chaque card â†’ page cours /espace-client/cours/[slug] (si tu veux la faire maintenant, crÃ©er sous-arborescence) avec lecteur vidÃ©o + ancrages (chapitres).

Tracking: sur events 25/50/100% (timeupdate), POST /api/events/video.

12) Admin lÃ©ger /admin/formations

Guard (rÃ´le OrgAdmin / SuperAdmin).

Table des orders (date, email, total, sku(s), status).

Somme CA par pÃ©riode, filtres date/sku.

Lien â€œvoir lâ€™Ã©lÃ¨veâ€ â†’ liste enrollments.

13) API â€” exemples (squelette)

/api/checkout/route.ts

Valider sku âˆˆ whitelist.

lookup_key = sku.

prices = await stripe.prices.list({lookup_keys:[lookup_key], active:true})

stripe.checkout.sessions.create({ line_items:[{price: prices.data[0].id, quantity:1}], mode:'payment', customer_email, success_url, cancel_url, client_reference_id, metadata })

return { url: session.url }

/api/stripe/webhook/route.ts

Lire raw body & signature.

event = stripe.webhooks.constructEvent(rawBody, sig, STRIPE_WEBHOOK_SECRET)

Case checkout.session.completed â†’ logique DB + email.

/api/events/video/route.ts

Auth user.

insert events (user_id, sku, type, meta).

14) Player vidÃ©o & tracking

IntÃ©grer Vimeo/Wistia/Cloudflare Stream ou HTML5.

Hook:

onplay â†’ video_start

Ã  25/50/100% â†’ POST event (eviter double envoi via state).

15) Emails (Resend ou SMTP)

Sujet: ğŸ“ Votre accÃ¨s â€“ {{course_title}}

Contenu: lien /espace-client, facture (lien Stripe), rappel garantie 14j (<30% visionnage), support.

CrÃ©er /lib/email.ts + /emails/receipt.tsx (React Email si Resend).

16) Copywriting (Ã  insÃ©rer dans courses.ts)

Utiliser les textes fournis:

Estimer 97â‚¬: H1, Hook, Learn list, Deliverables, Garantie.

Facebook 147â‚¬, Qualifier 97â‚¬, Porte Ouverte 147â‚¬ idem.

Pack 397â‚¬: hook + Ã©conomies + bonus courtier.

Catalogue: bandeau â€œArrive trÃ¨s bientÃ´tâ€, CTA prÃ©-lancement.

17) UI & composants

Components:

CourseCard.tsx (catalogue)

BuyButton.tsx (gÃ¨re disabled si COMING_SOON)

Price.tsx (format euros)

AdminTable.tsx

Tailwind + shadcn/ui (Button, Card, Badge, Dialog pour modals).

18) SÃ©curitÃ© & conformitÃ©

Valider sku cÃ´tÃ© serveur (whitelist).

Ne jamais prendre le price_id depuis le client.

Stocker SUPABASE_SERVICE_ROLE_KEY uniquement server-side.

CGV Formations, Politique vie privÃ©e, Droit de rÃ©tractation (produits numÃ©riques; condition: <30% visionnage).

Logs dâ€™events = Ã©lÃ©ment probant en cas de remboursement.

19) Tests locaux

Stripe CLI:

stripe listen --forward-to localhost:3000/api/stripe/webhook

Copier le WH_SECRET dans .env.

Flow:

/formations â†’ /formations/estimer-bien â†’ /paiement?sku=ESTIMER97

Payer avec carte test

VÃ©rifier webhook â†’ DB orders, order_items, enrollments

Email reÃ§u + accÃ¨s /espace-client

Events vidÃ©o sâ€™enregistrent

20) DÃ©ploiement & Nginx

Ajouter variables dâ€™env prod.

Assurer api/stripe/webhook raw body (dÃ©sactiver bodyParser si besoin dans middleware) â€” App Router gÃ¨re Request natif, lire arrayBuffer().

Ouvrir port HTTPS, vÃ©rifier proxy Nginx â†’ pass /api/* vers Node.

PM2 restart.

21) Bonus (optionnel immÃ©diat)

Upsell sÃ©rie emails si achat unitaire sans Pack: J+0, J+2, J+5 (Resend).

Coupons Stripe (prÃ©-lancement).

UTM tracking sur orders (lire cookies utm_*).

DÃ©finition de done

Pages /formations, /formations/[slug], /paiement, /merci, /espace-client, /admin/formations opÃ©rationnelles.

Paiement â†’ webhook â†’ DB â†’ accÃ¨s + email OK.

Copy visible et modifiable via content/courses.ts.

Tests Stripe CLI passants, events vidÃ©o logguÃ©s.